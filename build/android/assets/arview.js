var isAndroid="android"==Ti.Platform.osname,LDF=Ti.Platform.displayCaps.logicalDensityFactor||1,screenWidth=Math.min(Ti.Platform.displayCaps.platformWidth,Ti.Platform.displayCaps.platformHeight)/LDF,screenHeight=Math.max(Ti.Platform.displayCaps.platformWidth,Ti.Platform.displayCaps.platformHeight)/LDF,MAX_ZOOM=1,MIN_ZOOM=0.55,DELTA_ZOOM=MAX_ZOOM-MIN_ZOOM,numberOfpanels=4,MIN_Y=Math.floor(.1*screenHeight),MAX_Y=Math.floor(.65*screenHeight),DELTA_Y=MAX_Y-MIN_Y;isAndroid?Ti.Geolocation.accuracy=Ti.Geolocation.ACCURACY_LOW:(Ti.Geolocation.distanceFilter=100,Ti.Geolocation.preferredProvider="gps",Ti.Geolocation.accuracy=Ti.Geolocation.ACCURACY_NEAREST_TEN_METERS,Ti.Geolocation.purpose="Augmented Reality"),Ti.Geolocation.headingFilter=0.1,module.exports=function(params){function showAR(){Ti.App.Properties.hasProperty("lastGeolocation")&&locationCallback({coords:JSON.parse(Ti.App.Properties.getString("lastGeolocation"))}),Ti.Geolocation.addEventListener("heading",headingCallback),Ti.Geolocation.addEventListener("location",locationCallback)}function closeAR(){Ti.Geolocation.removeEventListener("heading",headingCallback),Ti.Geolocation.removeEventListener("location",locationCallback),isAndroid||console.log("camera closed"),$.removeAllChildren()}function headingCallback(e){var currBearing=e.heading.trueHeading||e.heading.magneticHeading;currBearing=TP.add(currBearing),radar.transform=Ti.UI.create2DMatrix().rotate(-currBearing);var internalBearing=currBearing/(360/panels.length),activeView=_Mathfloor(internalBearing),pixelOffset=screenWidth-_Mathfloor(internalBearing%1*screenWidth);activeView==lastActiveView?viewChange=!1:(viewChange=!0,lastActiveView=activeView);for(var diff,i=0;i<panels.length;i++)diff=activeView-i,-1<=diff&&1>=diff?(panels[i].center={y:centerY,x:pixelOffset-diff*screenWidth},viewChange&&(panels[i].visible=!0)):viewChange&&(panels[i].visible=!1);0==activeView?(panels[panels.length-1].center={y:centerY,x:panels[0].center.x-screenWidth},viewChange&&(panels[panels.length-1].visible=!0)):activeView==panels.length-1&&(panels[0].center={y:centerY,x:panels[panels.length-1].center.x+screenWidth},viewChange&&(panels[0].visible=!0))}function poiClick(e){Ti.API.debug("heard a click"),Ti.API.debug("number="+e.source.number);var poi=activePois[e.source.number],view=poi.view;$.fireEvent("click",{source:poi.view,poi:poi})}function locationCallback(e){myLocation=e.coords,redrawPois()}function redrawPois(){if(console.log("==redrawPois"),!myLocation)return void Ti.API.warn("location not known. Can't draw pois");for(var i=0;i<panels.length;i++)panels[i].removeAllChildren();if(console.log("==panels now empty"),radar.removeAllChildren(),activePois=[],$&&$.pois){for(var poi,i=0;i<$.pois.length&&12>i;i++)if(poi=$.pois[i],poi.view){var distance=calculateDistance(myLocation,poi);if($.maxDistance&&distance<$.maxDistance){poi.bearing=calculateBearing(myLocation,poi);var internalBearing=poi.bearing/(360/numberOfpanels);poi.distance=distance,poi.pixelOffset=internalBearing%1*screenWidth+(panels[0].width-screenWidth)/2,poi.activeView=_Mathfloor(internalBearing)%numberOfpanels,activePois.push(poi)}else Ti.API.debug(poi.title+" not added, maxDistance="+$.maxDistance)}else console.log("pois has no view");}else console.log("== no pois available");if(activePois.sort(function(a,b){return b.distance-a.distance}),activePois[0]){console.log("== activePois: "+activePois.length);for(var poi,maxDistance=activePois[0].distance,minDistance=activePois[activePois.length-1].distance,distanceDelta=maxDistance-minDistance,i=0;i<activePois.length;i++){poi=activePois[i],showColors;var distanceFromSmallest=poi.distance-minDistance,percentFromSmallest=1-distanceFromSmallest/distanceDelta,zoom=percentFromSmallest*DELTA_ZOOM+MIN_ZOOM,y=MIN_Y+percentFromSmallest*DELTA_Y,view=poi.view,transform=Ti.UI.create2DMatrix();transform=transform.scale(zoom),view.transform=transform,view.center={x:poi.pixelOffset,y:y},panels[poi.activeView].add(view);var nextView,nextOffset;poi.pixelOffset>panels[0].width/2?(nextView=poi.activeView+1,nextOffset=poi.pixelOffset-screenWidth):(nextView=poi.activeView-1,nextOffset=poi.pixelOffset+screenWidth),0>nextView?nextView=panels.length-1:nextView==panels.length&&(nextView=0),Ti.API.debug("nextView="+nextView),Ti.API.debug("nextOffset="+nextOffset)}}else console.log("no active POI")}var _Mathfloor=Math.floor,started=!1,$=Ti.UI.createView({width:Ti.UI.FILL,height:Ti.UI.FILL});$.maxDistance=params.maxDistance||2500,$.startAR=function(){started||(started=!0,$.add(require("pw.custom.androidcamera").createCameraView({width:Ti.UI.FILL,height:Ti.UI.FILL})),$.add(overlay))},$.stoppAR=function(){started=!1},$.setPOIs=function(pois){$.pois=pois,console.log("AR contains now "+pois.length+" pois"),redrawPois()};for(var panels=[],showColors=!1,colors=["red","yellow","pink","green","purple","orange","blue","aqua","white","silver"],myLocation=null,overlay=Ti.UI.createView({top:0,height:screenHeight,left:0,width:screenWidth,backgroundColor:"transparent"}),i=0;i<numberOfpanels;i++)panels[i]=Ti.UI.createView({top:0,height:screenHeight,right:0,width:1.6*screenWidth,visible:!1}),showColors,overlay.add(panels[i]);;var radar=Ti.UI.createView({backgroundImage:"/assets/radar.png",width:"80dp",height:"80dp",bottom:"10dp",left:"10dp",zIndex:9999,opacity:0.6});radar.addEventListener("click",closeAR);var compass=Ti.UI.createLabel({left:"50dp",color:"#009FE0",bottom:2,visible:!1});if(overlay.add(compass),!isAndroid){var button=Ti.UI.createButton({top:"5dp",right:"5dp",height:"45dp",width:"45dp",backgroundImage:"/images/close.png"});button.addEventListener("click",closeAR),overlay.add(button)}var activePois,lastActiveView=-1,viewChange=!1,centerY=screenHeight/2,TP=new(require("vendor/tiefpass"))({steps:3});setTimeout(showAR,500),$.assignPOIs=function(pois){$.pois=pois};;;return params.pois&&$.assignPOIs(params.pois),$};function toRad(val){return val*Math.PI/180};function calculateBearing(point1,point2){var _Mathcos=Math.cos,_Mathsin=Math.sin,lat1=toRad(point1.latitude),lat2=toRad(point2.latitude),dlng=toRad(point2.longitude-point1.longitude),y=_Mathsin(dlng)*_Mathcos(lat2),x=_Mathcos(lat1)*_Mathsin(lat2)-_Mathsin(lat1)*_Mathcos(lat2)*_Mathcos(dlng),brng=Math.atan2(y,x);return(brng*(180/Math.PI)+360)%360};function calculateDistance(loc1,loc2){var _Mathsqrt=Math.sqrt,_Mathcos2=Math.cos,_Mathsin2=Math.sin,R=6371,dLat=toRad(loc2.latitude-loc1.latitude),dLon=toRad(loc2.longitude-loc1.longitude),a=_Mathsin2(dLat/2)*_Mathsin2(dLat/2)+_Mathcos2(toRad(loc1.latitude))*_Mathcos2(toRad(loc2.latitude))*_Mathsin2(dLon/2)*_Mathsin2(dLon/2),c=2*Math.atan2(_Mathsqrt(a),_Mathsqrt(1-a));return 1e3*(R*c)};